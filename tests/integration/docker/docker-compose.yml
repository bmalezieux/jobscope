x-slurm-image: &slurm-image jobscope/slurm-test:${SLURM_VERSION:-25.05.3}
x-slurm-build: &slurm-build
  context: ../..
  dockerfile: tests/integration/docker/Dockerfile.slurm-test
  args:
    SLURM_BASE_IMAGE: ${SLURM_IMAGE_REPO:-ghcr.io/bmalezieux/slurm-docker-cluster}:${SLURM_VERSION:-25.05.3}
    HTTP_PROXY: ${HTTP_PROXY-}
    HTTPS_PROXY: ${HTTPS_PROXY-}
    NO_PROXY: ${NO_PROXY-}
x-slurm-env: &slurm-env
  HTTP_PROXY: ${HTTP_PROXY-}
  HTTPS_PROXY: ${HTTPS_PROXY-}
  NO_PROXY: ${NO_PROXY-}

services:
  mysql:
    image: mariadb:10.10
    hostname: mysql
    container_name: slurm-docker-cluster-mysql
    environment:
      MYSQL_RANDOM_ROOT_PASSWORD: "yes"
      MYSQL_DATABASE: slurm_acct_db
      MYSQL_USER: slurm
      MYSQL_PASSWORD: password
    volumes:
      - var_lib_mysql:/var/lib/mysql
    networks:
      - slurm-network
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  slurmdbd:
    image: *slurm-image
    build: *slurm-build
    command: ["slurmdbd"]
    container_name: slurm-docker-cluster-slurmdbd
    hostname: slurmdbd
    environment:
      <<: *slurm-env
      MYSQL_USER: slurm
      MYSQL_PASSWORD: password
    volumes:
      - etc_munge:/etc/munge
      - etc_slurm:/etc/slurm
      - var_log_slurm:/var/log/slurm
    expose:
      - "6819"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - slurm-network
    healthcheck:
      test: ["CMD-SHELL", "pidof slurmdbd"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s

  slurmctld:
    image: *slurm-image
    build: *slurm-build
    command: ["slurmctld"]
    container_name: slurm-docker-cluster-slurmctld
    hostname: slurmctld
    privileged: true
    working_dir: /data
    environment:
      <<: *slurm-env
    volumes:
      - etc_munge:/etc/munge:z
      - etc_slurm:/etc/slurm:z
      - slurm_jobdir:/data:z
      - var_log_slurm:/var/log/slurm:z
      - ../../:/jobscope:z
    expose:
      - "6817"
    depends_on:
      slurmdbd:
        condition: service_healthy
    networks:
      - slurm-network
    healthcheck:
      test: ["CMD-SHELL", "scontrol ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s

  slurmrestd:
    image: *slurm-image
    build: *slurm-build
    command: ["slurmrestd"]
    container_name: slurm-docker-cluster-slurmrestd
    hostname: slurmrestd
    privileged: true
    environment:
      <<: *slurm-env
    volumes:
      - etc_munge:/etc/munge
      - etc_slurm:/etc/slurm
      - var_log_slurm:/var/log/slurm
    ports:
      - "6820:6820"
    expose:
      - "6820"
    depends_on:
      slurmctld:
        condition: service_healthy
    networks:
      - slurm-network
    healthcheck:
      test: ["CMD-SHELL", "test -S /var/run/slurmrestd/slurmrestd.socket"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s

  c1:
    image: *slurm-image
    build: *slurm-build
    command: ["slurmd"]
    container_name: slurm-docker-cluster-c1
    hostname: c1
    working_dir: /data
    privileged: true
    environment:
      <<: *slurm-env
    volumes:
      - etc_munge:/etc/munge
      - etc_slurm:/etc/slurm
      - slurm_jobdir:/data
      - var_log_slurm:/var/log/slurm
      - ../../:/jobscope
    expose:
      - "6818"
    depends_on:
      slurmctld:
        condition: service_healthy
    networks:
      - slurm-network
    healthcheck:
      test: ["CMD-SHELL", "pidof slurmd"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s

  c2:
    image: *slurm-image
    build: *slurm-build
    command: ["slurmd"]
    container_name: slurm-docker-cluster-c2
    hostname: c2
    working_dir: /data
    privileged: true
    environment:
      <<: *slurm-env
    volumes:
      - etc_munge:/etc/munge
      - etc_slurm:/etc/slurm
      - slurm_jobdir:/data
      - var_log_slurm:/var/log/slurm
      - ../../:/jobscope
    expose:
      - "6818"
    depends_on:
      slurmctld:
        condition: service_healthy
    networks:
      - slurm-network
    healthcheck:
      test: ["CMD-SHELL", "pidof slurmd"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s

volumes:
  etc_munge:
  etc_slurm:
  slurm_jobdir:
  var_lib_mysql:
  var_log_slurm:

networks:
  slurm-network:
    driver: bridge
