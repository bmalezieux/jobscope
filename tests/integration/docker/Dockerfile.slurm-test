ARG SLURM_BASE_IMAGE=ghcr.io/bmalezieux/slurm-docker-cluster:25.05.3
FROM ${SLURM_BASE_IMAGE}

ARG JOBSCOPE_DEPS_HASH=""

ARG HTTP_PROXY
ARG HTTPS_PROXY
ARG NO_PROXY

ENV HTTP_PROXY=${HTTP_PROXY}
ENV HTTPS_PROXY=${HTTPS_PROXY}
ENV NO_PROXY=${NO_PROXY}

ENV UV_INSTALL_DIR=/usr/local/bin
ENV UV_PYTHON_INSTALL_DIR=/opt/uv/python
ENV UV_CACHE_DIR=/opt/uv/cache
ENV PATH="/usr/local/bin:/root/.local/bin:${PATH}"

LABEL jobscope.deps-hash="${JOBSCOPE_DEPS_HASH}"

COPY tests/integration/docker/apt-sources/ /tmp/apt-sources/

RUN set -eux; \
    if [ -f /tmp/apt-sources/sources.list ]; then \
        cp /tmp/apt-sources/sources.list /etc/apt/sources.list; \
    fi; \
    if ls /tmp/apt-sources/*.list >/dev/null 2>&1; then \
        mkdir -p /etc/apt/sources.list.d; \
        rm -f /etc/apt/sources.list.d/*.list; \
        cp -a /tmp/apt-sources/*.list /etc/apt/sources.list.d/; \
    fi

RUN set -eux; \
    if command -v apt-get >/dev/null; then \
        apt-get update; \
        apt-get install -y --no-install-recommends curl ca-certificates; \
        rm -rf /var/lib/apt/lists/*; \
    elif command -v dnf >/dev/null; then \
        dnf install -y --allowerasing curl ca-certificates; \
        dnf clean all; \
    elif command -v yum >/dev/null; then \
        yum install -y curl ca-certificates; \
        yum clean all; \
    else \
        echo "No supported package manager found to install curl/ca-certificates"; \
        exit 1; \
    fi

RUN curl -LsSf https://astral.sh/uv/install.sh | sh

RUN mkdir -p "${UV_PYTHON_INSTALL_DIR}" "${UV_CACHE_DIR}" \
    && uv python install 3.12
